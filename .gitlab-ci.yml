stages:
  - lint
  - tests
  - security-pre-scans

default:
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

lint-code:
  image: node:20-bullseye
  stage: lint
  before_script:
    - node -v
    - npm -v
    - ls -la
    - cat package.json
    - if [ -f package-lock.json ]; then npm ci; else npm install; fi
  script:
    - npm run lint


lint-yml:
  image: python:3.12-slim
  stage: lint
  before_script:
    - pip install --no-cache-dir yamllint
  script:
    - yamllint -c .yamllint docker-compose.yml docker-compose.full.yml .gitlab-ci.yml

lint-dockerfile:
  image: hadolint/hadolint:v2.12.0-alpine
  stage: lint
  script:
    - hadolint Dockerfile

unit-tests:
  image: node:20-bullseye
  stage: tests
  variables:
    NODE_ENV: test

    DB_HOST: localhost
    DB_PORT: "5432"
    DB_USER: postgres
    DB_PW: postgres
    DB_NAME: test_db

    DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db?schema=public

    MONGO_URI: mongodb://localhost:27017/test_db

    JWT_SECRET: test_secret

    PORT: "3001"
  before_script:
    - npm ci
  script:
    - npm test

code-static-analysis:
  image: returntocorp/semgrep:1.92.0
  stage: security-pre-scans
  allow_failure: true
  script:
    - semgrep --config=auto --error

dependencies-scan:
  image: node:20-bullseye
  stage: security-pre-scans
  allow_failure: true
  before_script:
    - npm ci
  script:
    - npm audit --audit-level=high
